(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{100:function(t,e,n){t.exports=n(239)},105:function(t,e,n){},107:function(t,e,n){},239:function(t,e,n){"use strict";n.r(e);var i=n(0),a=n.n(i),s=n(27),c=n.n(s),o=(n(105),n(16)),h=n(17),l=n(98),r=n(91),u=n(99),d=(n(107),n(92)),g=n.n(d),k=n(93),p=n.n(k),f=n(94),v=n.n(f),y=n(36),b=n.n(y),m=n(95),w=n.n(m),O=n(37),I=n(96),B=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{gameId:"",tileIndex:-1,type:!1},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Date.now()/1e3;Object(o.a)(this,t),this.index=0,this.action={},this.hash="",this.previousHash="",this.timestamp=0,this.index=e,this.previousHash=i,this.action=n,this.timestamp=a,this.hash=this.getHash()}return Object(h.a)(t,[{key:"getHash",value:function(){return b()("".concat(this.index).concat(this.previousHash).concat(JSON.stringify(this.action)).concat(this.timestamp))}},{key:"clone",value:function(){return new t(this.index,this.action,this.previousHash,this.timestamp)}}]),t}(),E=["","","","","","","","",""],S=function(){function t(){var e=this;Object(o.a)(this,t),this.blockchain=[],this.callback=function(){},this.bus=null,this.state={},this.blockchain.push(this.createGenesisBlock()),setTimeout(function(){return e.restoreChain()},0)}return Object(h.a)(t,[{key:"setBus",value:function(t){this.bus=t}},{key:"update",value:function(t){this.callback=t}},{key:"getChain",value:function(){return this.blockchain}},{key:"getLastBlock",value:function(){return this.blockchain[this.blockchain.length-1]}},{key:"createGenesisBlock",value:function(){return new B(0,{},"0",0)}},{key:"nextBlock",value:function(t,e){var n=t.index+1,i=t.hash;return new B(n,e,i)}},{key:"pushBlock",value:function(t){try{this.state=this.calculateState([t],this.state),this.blockchain.push(t),this.saveChain(),this.bus.onAddBlock(),this.callback(this.state)}catch(e){console.warn(e.message)}}},{key:"addBlock",value:function(t){var e=this.nextBlock(this.getLastBlock(),t);if(!this.isValidNewBlock(e,this.getLastBlock()))return!1;this.pushBlock(e)}},{key:"applyBlock",value:function(t){this.isValidNewBlock(t,this.getLastBlock())&&(this.pushBlock(t),console.log("Receive block:",t.index,t.hash))}},{key:"isValidNewBlock",value:function(t,e){return e.index+1!==t.index?(console.log("Invalid index"),!1):e.hash!==t.previousHash?(console.log("Invalid previoushash"),!1):t.getHash()===t.hash||(console.log("Invalid hash: "+t.getHash()+" "+t.hash),!1)}},{key:"isValidChain",value:function(t){if(JSON.stringify(t[0])!==JSON.stringify(this.createGenesisBlock()))return!1;for(var e=[t[0]],n=1;n<t.length;n++){if(!this.isValidNewBlock(t[n],e[n-1]))return!1;e.push(t[n])}return!0}},{key:"replaceChain",value:function(t){if(this.isValidChain(t)&&t.length>this.blockchain.length){console.log("Received blockchain is valid. Replacing current blockchain with received blockchain");try{this.state=this.calculateState(t),this.blockchain=t,this.callback(this.state),this.saveChain()}catch(e){console.warn(e.message)}}else console.log("Received blockchain invalid")}},{key:"saveChain",value:function(){window.localStorage.setItem("chain",JSON.stringify(this.blockchain))}},{key:"restoreChain",value:function(){var t=window.localStorage.getItem("chain")||"[]",e=JSON.parse(t).map(function(t){var e=t.index,n=t.action,i=t.previousHash,a=t.timestamp;return new B(e,n,i,a)});if(e.length)try{this.state=this.calculateState(e),this.blockchain=e,this.callback(this.state)}catch(n){console.warn(n.message)}}},{key:"calculateState",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t.reduce(function(t,e){var n=e.action,i=t[n.gameId]&&t[n.gameId].tiles||E.slice();if(void 0===n.tileIndex)return t;if(""!==i[n.tileIndex])throw new Error("Invalid action");return i[n.tileIndex]=n.type,Object(I.a)({},t,Object(O.a)({},n.gameId,{tiles:i,type:n.type}))},e)}}]),t}(),C=(n(200),function(){function t(){var e=this;Object(o.a)(this,t),this.logging=!0,this.id="",this.peer=null,this.peerOptions={host:window.location.hostname,port:9e3,path:"/peerjs"},this.connections=[],this.id=b()("".concat(Date.now()).concat(Math.random())),this.blockchain=new S,this.blockchain.setBus(this),this.peer=new Peer(this.id,this.peerOptions),this.peer.on("connection",function(t){t.on("data",function(n){e.connections=e.connections.concat([t]),e.handleMessage(t,n)}),t.on("close",function(){e.connections=e.connections.filter(function(e){return e!==t})})}),w.a.post("//".concat(this.peerOptions.host,":").concat(this.peerOptions.port,"/connect"),{id:this.id}).then(function(t){return t.data}).then(function(t){t.forEach(function(t){var n=e.peer.connect(t);n.on("open",function(){n.on("data",function(t){e.handleMessage(n,t)}),e.connections=e.connections.concat([n]),n.send(e.queryChainLengthMsg())}),n.on("close",function(){e.connections=e.connections.filter(function(t){return t!==n})})})})}return Object(h.a)(t,[{key:"getBlockchain",value:function(){return this.blockchain}},{key:"onAddBlock",value:function(){this.broadcast(this.responseLatestMsg())}},{key:"handleMessage",value:function(t,e){var n=JSON.parse(e);switch(this.log("Received message "+JSON.stringify(n)),n.type){case"QUERY_LATEST":t.send(this.responseLatestMsg());break;case"QUERY_ALL":t.send(this.responseChainMsg());break;case"RESPONSE_BLOCKCHAIN":this.handleBlockchainResponse(n);break;default:return}}},{key:"handleBlockchainResponse",value:function(t){var e=t.data.map(function(t){var e=t.index,n=t.action,i=t.previousHash,a=t.timestamp;return new B(e,n,i,a)}).sort(function(t,e){return t.index-e.index}),n=e[e.length-1],i=this.blockchain.getLastBlock();n.index>i.index?(this.log("blockchain possibly behind. We got: "+i.index+" Peer got: "+n.index),i.hash===n.previousHash?(this.log("We can append the received block to our chain"),this.blockchain.applyBlock(n),this.broadcast(this.responseLatestMsg())):1===e.length?(this.log("We have to query the chain from our peer"),this.broadcast(this.queryAllMsg())):(this.log("Received blockchain is longer than current blockchain"),this.blockchain.replaceChain(e),this.broadcast(this.responseLatestMsg()))):this.log("received blockchain is not longer than current blockchain. Do nothing")}},{key:"queryChainLengthMsg",value:function(){return this.log("QUERY_LATEST"),JSON.stringify({type:"QUERY_LATEST"})}},{key:"queryAllMsg",value:function(){return this.log("QUERY_ALL"),JSON.stringify({type:"QUERY_ALL"})}},{key:"responseChainMsg",value:function(){return this.log("responseChainMsg","RESPONSE_BLOCKCHAIN"),JSON.stringify({type:"RESPONSE_BLOCKCHAIN",data:this.blockchain.getChain()})}},{key:"responseLatestMsg",value:function(){return this.log("responseLatestMsg","RESPONSE_BLOCKCHAIN"),JSON.stringify({type:"RESPONSE_BLOCKCHAIN",data:[this.blockchain.getLastBlock()]})}},{key:"broadcast",value:function(t){this.connections.forEach(function(e){e.send(t)})}},{key:"log",value:function(){var t;this.logging&&(t=console).log.apply(t,arguments)}}]),t}()),L={cross:!0,circle:!1},x={largeIcon:{width:60,height:60},large:{width:120,height:120,padding:30},app:{display:"inline-block"},field:{margin:"auto",width:360,height:360,border:"1px solid"}},N=["","","","","","","","",""],R=function(t){function e(t){var n;return Object(o.a)(this,e),(n=Object(l.a)(this,Object(r.a)(e).call(this,t))).handleTileClick=function(t){n.chain.addBlock({gameId:n.state.gameId,tileIndex:t,type:!(n.state.state[n.state.gameId]&&n.state.state[n.state.gameId].type)})},n.state={state:{}},n.state.gameId=t.gameId,n.state.state[n.state.gameId]={tiles:N.slice(),type:L.cross},n}return Object(u.a)(e,t),Object(h.a)(e,[{key:"componentDidMount",value:function(){var t=this,e=new C;this.chain=e.getBlockchain(),this.chain.update(function(e){t.setState({state:e})}),window.lol=this.chain}},{key:"render",value:function(){var t=this;return a.a.createElement("div",{style:x.app},a.a.createElement("label",null,"Game id: ",a.a.createElement("input",{type:"number",value:this.state.gameId,onChange:function(e){t.setState({gameId:e.target.value})}})),a.a.createElement("h5",null,this.state.state[this.state.gameId]&&this.state.state[this.state.gameId].type===L.cross?"circle":"cross"),a.a.createElement("div",{style:x.field},(this.state.state[this.state.gameId]&&this.state.state[this.state.gameId].tiles||N).map(function(e,n){return a.a.createElement(g.a,{key:n,iconStyle:x.largeIcon,style:x.large,onClick:function(){return t.handleTileClick(n)}},e===L.cross&&a.a.createElement(p.a,null),e===L.circle&&a.a.createElement(v.a,null))})))}}]),e}(i.Component),M=n(97),H=n.n(M);c.a.render(a.a.createElement(H.a,null,a.a.createElement(R,{gameId:"1"})),document.getElementById("root"))}},[[100,2,1]]]);
//# sourceMappingURL=main.584e9b82.chunk.js.map